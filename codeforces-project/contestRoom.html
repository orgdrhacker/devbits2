<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contest Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
  <!-- Navigation Header -->
  <header class="bg-gray-800 p-4 shadow-lg w-full">
    <nav class="flex items-center">
      <div>
        <a href="index.html" class="text-2xl font-bold pl-4">Coderia</a>
      </div>
      <div class="flex ml-auto items-center space-x-6 pr-4">
        <a href="index.html" class="text-lg font-semibold hover:underline">HOME</a>
        <a href="profile.html" class="text-lg font-semibold hover:underline">PROFILE</a>
        <a href="submissions.html" class="text-lg font-semibold hover:underline">SUBMISSIONS</a>
        <a href="contest_list.html" class="text-lg font-semibold hover:underline">CONTESTS</a>
        <a href="problemset.html" class="text-lg font-semibold hover:underline">PROBLEMSET</a>
        <a href="compare.html" class="text-lg font-semibold hover:underline">COMPARE</a>
        <div id="auth-item">
          <a href="login.html" id="auth-link" class="text-lg font-semibold hover:underline">LOGIN</a>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main Contest Room Content -->
  <div class="max-w-4xl mx-auto mt-12 bg-gray-800 p-6 rounded-lg shadow-lg">
    <h1 id="contestName" class="text-3xl font-bold mb-4">Loading contest...</h1>
    <div id="countdown" class="text-xl mb-6">Countdown: Loading...</div>
    <h2 class="text-2xl font-bold mb-4">Problems</h2>
    <div id="problemsSection" class="bg-gray-700 p-4 rounded mb-6">Loading problems...</div>
    
    <!-- Friend Standing Section -->
    <div id="friendStandingSection" class="hidden">
      <button id="showFriendsBtn" class="bg-blue-600 px-4 py-2 rounded text-white hover:bg-blue-700 mb-4">
        Show Friend Standing
      </button>
      <div id="scoreboard" class="overflow-x-auto">Loading scoreboard...</div>
    </div>
  </div>

  <script>
    // Get contest ID from URL
    function getContestId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    // Load contest from localStorage by contestId
    function loadContest() {
      const id = getContestId();
      if (!id) {
        document.getElementById("contestName").textContent = "No contest ID provided.";
        document.getElementById("countdown").textContent = "";
        document.getElementById("problemsSection").textContent = "";
        return null;
      }
      const contests = JSON.parse(localStorage.getItem("contests")) || [];
      const contest = contests.find(c => c.contestId == id);
      if (!contest) {
        document.getElementById("contestName").textContent = "Invalid contest ID.";
        document.getElementById("countdown").textContent = "";
        document.getElementById("problemsSection").textContent = "";
        return null;
      }
      return contest;
    }

    // Setup countdown timer
    function setupCountdown(startTime, duration) {
      const countdownEl = document.getElementById("countdown");
      const friendSection = document.getElementById("friendStandingSection");
      let interval = setInterval(() => {
        const now = Date.now();
        if (now < startTime) {
          const remain = startTime - now;
          const secs = Math.floor(remain / 1000);
          const hh = String(Math.floor(secs / 3600)).padStart(2, '0');
          const mm = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
          const ss = String(secs % 60).padStart(2, '0');
          countdownEl.textContent = `Contest starts in: ${hh}:${mm}:${ss}`;
        } else {
          const endTime = startTime + duration;
          const remain = endTime - now;
          if (remain <= 0) {
            countdownEl.textContent = "Contest ended!";
            clearInterval(interval);
          } else {
            const secs = Math.floor(remain / 1000);
            const hh = String(Math.floor(secs / 3600)).padStart(2, '0');
            const mm = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
            const ss = String(secs % 60).padStart(2, '0');
            countdownEl.textContent = `Contest ends in: ${hh}:${mm}:${ss}`;
            friendSection.classList.remove("hidden");
          }
        }
      }, 1000);
    }

    // Display contest problems
    function displayProblems(problems) {
      const section = document.getElementById("problemsSection");
      if (!problems || problems.length === 0) {
        section.textContent = "No problems selected for this contest.";
        return;
      }
      let html = `
        <table class="min-w-full border-collapse">
          <thead class="bg-gray-800">
            <tr>
              <th class="px-4 py-2 border border-gray-600">Name</th>
              <th class="px-4 py-2 border border-gray-600">ContestID</th>
              <th class="px-4 py-2 border border-gray-600">Index</th>
              <th class="px-4 py-2 border border-gray-600">Rating</th>
              <th class="px-4 py-2 border border-gray-600">Tags</th>
            </tr>
          </thead>
          <tbody>
      `;
      problems.forEach(prob => {
        const url = `https://codeforces.com/problemset/problem/${prob.contestId}/${prob.index}`;
        html += `
          <tr class="hover:bg-gray-800">
            <td class="px-4 py-2 border border-gray-600">
              <a href="${url}" target="_blank" class="text-blue-400 hover:underline">${prob.name}</a>
            </td>
            <td class="px-4 py-2 border border-gray-600">${prob.contestId}</td>
            <td class="px-4 py-2 border border-gray-600">${prob.index}</td>
            <td class="px-4 py-2 border border-gray-600">${prob.rating || "N/A"}</td>
            <td class="px-4 py-2 border border-gray-600">${prob.tags.join(", ")}</td>
          </tr>
        `;
      });
      html += `</tbody></table>`;
      section.innerHTML = html;
    }

    // Fetch friend submissions (only count those after contest start)
    async function fetchFriendSubmissions(handle, problems, contestStartTime) {
      const friendResult = {
        handle: handle,
        solves: {},
        solvedCount: 0,
        sumTime: 0
      };
      problems.forEach(p => {
        const key = `${p.contestId}-${p.index}`;
        friendResult.solves[key] = { solved: false, time: null };
      });
      try {
        const response = await fetch(`https://codeforces.com/api/user.status?handle=${handle}&count=100000`);
        const data = await response.json();
        if (data.status !== "OK") return friendResult;
        const submissions = data.result;
        for (let sub of submissions) {
          if (sub.verdict === "OK" && sub.problem && (sub.creationTimeSeconds * 1000) >= contestStartTime) {
            const key = `${sub.problem.contestId}-${sub.problem.index}`;
            if (friendResult.solves[key] && !friendResult.solves[key].solved) {
              friendResult.solves[key].solved = true;
              friendResult.solves[key].time = sub.creationTimeSeconds;
            } else if (friendResult.solves[key] && friendResult.solves[key].solved) {
              if (sub.creationTimeSeconds < friendResult.solves[key].time) {
                friendResult.solves[key].time = sub.creationTimeSeconds;
              }
            }
          }
        }
        let count = 0, sumTime = 0;
        for (let key in friendResult.solves) {
          if (friendResult.solves[key].solved) {
            count++;
            sumTime += friendResult.solves[key].time;
          }
        }
        friendResult.solvedCount = count;
        friendResult.sumTime = sumTime;
      } catch (err) {
        console.error(`Error fetching submissions for ${handle}:`, err);
      }
      return friendResult;
    }

    async function buildScoreboard(problems, contestStartTime) {
      const scoreboardEl = document.getElementById("scoreboard");
      scoreboardEl.innerHTML = "Loading scoreboard...";
      let friends = JSON.parse(localStorage.getItem("cf_friends")) || [];
      if (friends.length === 0) {
        scoreboardEl.innerHTML = "<p>No friends found. Please add friends first.</p>";
        return;
      }
      const scoreboardData = [];
      for (let handle of friends) {
        let data = await fetchFriendSubmissions(handle, problems, contestStartTime);
        scoreboardData.push(data);
      }
      // Sort by solvedCount (desc) then by sumTime (asc)
      scoreboardData.sort((a, b) => {
        if (a.solvedCount !== b.solvedCount) {
          return b.solvedCount - a.solvedCount;
        } else {
          return a.sumTime - b.sumTime;
        }
      });
      let html = `
        <table class="min-w-full border-collapse">
          <thead class="bg-gray-800">
            <tr>
              <th class="px-4 py-2 border border-gray-600">Rank</th>
              <th class="px-4 py-2 border border-gray-600">Friend</th>
      `;
      problems.forEach((p, idx) => {
        html += `<th class="px-4 py-2 border border-gray-600">P${idx+1}</th>`;
      });
      html += `
              <th class="px-4 py-2 border border-gray-600">Total Solved</th>
            </tr>
          </thead>
          <tbody>
      `;
      scoreboardData.forEach((friend, i) => {
        html += `<tr class="hover:bg-gray-800">
                   <td class="px-4 py-2 border border-gray-600">${i + 1}</td>
                   <td class="px-4 py-2 border border-gray-600">${friend.handle}</td>`;
        problems.forEach((p) => {
          const key = `${p.contestId}-${p.index}`;
          const info = friend.solves[key];
          if (info && info.solved) {
            const timeStr = new Date(info.time * 1000).toLocaleTimeString("en-IN", { timeZone: "Asia/Kolkata" });
            html += `<td class="px-4 py-2 border border-gray-600 text-green-400">AC (${timeStr})</td>`;
          } else {
            html += `<td class="px-4 py-2 border border-gray-600 text-red-400">--</td>`;
          }
        });
        html += `<td class="px-4 py-2 border border-gray-600">${friend.solvedCount}</td></tr>`;
      });
      html += `</tbody></table>`;
      scoreboardEl.innerHTML = html;
    }

    // Show friend standing on button click
    document.getElementById("showFriendsBtn").addEventListener("click", async function() {
      const contest = loadContest();
      if (!contest) return;
      await buildScoreboard(contest.problems, contest.startTime);
    });

    // Initialize contest room page
    function initContestRoom() {
      const contest = loadContest();
      if (!contest) return;
      document.getElementById("contestName").textContent = contest.name || "Unnamed Contest";
      displayProblems(contest.problems);
      setupCountdown(contest.startTime, contest.duration);
    }
    document.addEventListener("DOMContentLoaded", initContestRoom);
  </script>
</body>
</html>
